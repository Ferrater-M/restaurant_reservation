{% extends 'rr_app/auth_base.html' %}
{% load static %}
{% block title %}Reset Password - Restaurant Reservation{% endblock %}

{% block content %}

<p id="resetPass">Set New Password</p>
<form>
  <input type="password" id="newPassword" placeholder="New password" required>
  <input type="password" id="confirmPassword" placeholder="Confirm new password" required>
  <input type="button" value="Update Password" id="btnUpdatePassword">
  <p class="error-msg" id="errorMsg"></p>
  <p class="success-msg" id="successMsg" style="display: none;"></p>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const btnUpdate = document.getElementById('btnUpdatePassword');
  const newPassword = document.getElementById('newPassword');
  const confirmPassword = document.getElementById('confirmPassword');
  const errorMsg = document.getElementById('errorMsg');
  const successMsg = document.getElementById('successMsg');
  
  // Get access token from URL hash
  const hash = window.location.hash.substring(1);
  const params = new URLSearchParams(hash);
  const accessToken = params.get('access_token');
  
  if (!accessToken) {
    errorMsg.textContent = 'Invalid reset link';
    return;
  }
  
  btnUpdate.addEventListener('click', async () => {
    const newPass = newPassword.value.trim();
    const confirmPass = confirmPassword.value.trim();
    
    if (!newPass || !confirmPass) {
      errorMsg.textContent = 'Please fill in both fields';
      return;
    }
    
    if (newPass !== confirmPass) {
      errorMsg.textContent = 'Passwords do not match';
      return;
    }
    
    if (newPass.length < 8) {
      errorMsg.textContent = 'Password must be at least 8 characters';
      return;
    }
    
    try {
      const response = await fetch('/rr/update_password/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          access_token: accessToken,
          new_password: newPass
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        successMsg.textContent = data.message;
        successMsg.style.display = 'block';
        errorMsg.textContent = '';
        
        setTimeout(() => {
          window.location.href = '/rr/login/';
        }, 2000);
      } else {
        errorMsg.textContent = data.error || 'Failed to update password';
      }
    } catch (error) {
      errorMsg.textContent = 'Network error occurred';
      console.error('Password update error:', error);
    }
  });
});
</script>
{% endblock %}